function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("geo-ambient-occlusion")),r=e(require("regl")),n=require("gl-matrix/vec3"),i=require("@gltf-transform/core"),o=require("@gltf-transform/extensions"),a=e(require("get-pixels")),s=e(require("save-pixels"));function u(){return(u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function f(e){var t=0;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=function(e,t){if(e){if("string"==typeof e)return c(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?c(e,void 0):void 0}}(e)))return function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(t=e[Symbol.iterator]()).next.bind(t)}var l=t,g=r,m={resolution:512,samples:500},p=new Uint8Array([137,80,78,71,13,10,26,10,0,0,0,13,73,72,68,82,0,0,1,0,0,0,0,1,8,6,0,0,0,49,89,112,119,0,0,0,32,73,68,65,84,56,79,99,100,96,96,248,207,196,196,196,0,2,163,244,104,56,140,166,131,145,147,15,24,25,25,25,0,254,131,3,254,243,176,75,70,0,0,0,0,73,69,78,68,174,66,96,130]).buffer;function d(e){for(var t,r={min:[Infinity,Infinity,Infinity],max:[-Infinity,-Infinity,-Infinity]},n=f(e instanceof i.Node?[e]:e.listChildren());!(t=n()).done;)t.value.traverse(function(e){if(e.getMesh()){var t=h(e.getMesh(),e.getWorldMatrix());v(t.min,r),v(t.max,r)}});return r}function h(e,t){for(var r,i={min:[Infinity,Infinity,Infinity],max:[-Infinity,-Infinity,-Infinity]},o=f(e.listPrimitives());!(r=o()).done;)for(var a=r.value.getAttribute("POSITION"),s=[0,0,0],u=[0,0,0],c=0;c<a.getCount();c++)s=a.getElement(c,s),v(u=n.transformMat4(u,s,t),i);return i}function v(e,t){for(var r=0;r<3;r++)t.min[r]=Math.min(e[r],t.min[r]),t.max[r]=Math.max(e[r],t.max[r])}var y={pivot:"center"},b={accessors:!0,textures:!0},S=function(e,t,r){try{return e?Promise.resolve(new Promise(function(t,r){x(Buffer.from(e.getImage()),e.getMimeType(),function(e,n){return e?r(e):t(n)})})).then(function(e){for(var n=0;n<e.shape[0];++n)for(var o=0;o<e.shape[1];++o)r(e,n,o);return Promise.resolve(new Promise(function(t,r){var n=[];I(e,"png").on("data",function(e){return n.push(e)}).on("end",function(){return t(i.BufferUtils.trim(Buffer.concat(n)))}).on("error",function(e){return r(e)})})).then(function(e){return t.setImage(e).setMimeType("image/png")})}):Promise.resolve(null)}catch(e){return Promise.reject(e)}},x=a,I=s,A="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function E(e,t,r){if(!e.s){if(r instanceof T){if(!r.s)return void(r.o=E.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(E.bind(null,e,t),E.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}var T=function(){function e(){}return e.prototype.then=function(t,r){var n=new e,i=this.s;if(i){var o=1&i?t:r;if(o){try{E(n,1,o(this.v))}catch(e){E(n,2,e)}return n}return this}return this.o=function(e){try{var i=e.v;1&e.s?E(n,1,t?t(i):i):r?E(n,1,r(i)):E(n,2,i)}catch(e){E(n,2,e)}},n},e}();function R(e){return e instanceof T&&1&e.s}var N="partition",P={animations:!0,meshes:!0};function w(e,t){for(var r=e+".bin",n=1;t.has(r);)r=e+"_"+n+++".bin";return r}var M={name:"",fps:10,pattern:null,sort:!0};function C(e){return{properties:e.getRoot().listScenes().map(function(e){var t=e.listChildren()[0],r=d(e);return{name:e.getName(),rootName:t?t.getName():"",bboxMin:z(r.min),bboxMax:z(r.max)}})}}function O(e){return{properties:e.getRoot().listMeshes().map(function(e){var t=e.listParents().filter(function(e){return"Root"!==e.propertyType}).length,r=0,n=0,i=0,o=new Set,a=new Set,s=new Set;e.listPrimitives().forEach(function(e){e.listSemantics().forEach(function(e){return a.add(e)});for(var t,u=f(e.listAttributes());!(t=u()).done;){var c=t.value;o.add(c.getArray().constructor.name),s.add(c)}for(var l,g=f(e.listTargets());!(l=g()).done;)for(var m,p=f(l.value.listAttributes());!(m=p()).done;){var d=m.value;o.add(d.getArray().constructor.name),s.add(d)}if(e.getIndices()){var h=e.getIndices();o.add(h.getArray().constructor.name),i++,s.add(h)}n+=e.getAttribute("POSITION").getCount(),r+=function(e){switch(e.getMode()){case 0:return e.getAttribute("POSITION").getCount();case 1:return e.getIndices()?e.getIndices().getCount()/2:e.getAttribute("POSITION").getCount()/2;case 2:return e.getAttribute("POSITION").getCount();case 3:return e.getAttribute("POSITION").getCount()-1;case 4:return e.getIndices()?e.getIndices().getCount()/3:e.getAttribute("POSITION").getCount()/3;case 5:case 6:return e.getAttribute("POSITION").getCount()-2;default:throw new Error("Unexpected mode: "+e.getMode())}}(e)});var u=0;Array.from(s).forEach(function(e){return u+=e.getArray().byteLength});var c=e.listPrimitives().map(function(e){return L[e.getMode()]});return{name:e.getName(),mode:Array.from(new Set(c)),primitives:e.listPrimitives().length,glPrimitives:r,vertices:n,indexed:e.listPrimitives().length===i,components:Array.from(o).sort().map(function(e){return e.replace("Array","")}),attributes:Array.from(a).sort(),instances:t,size:u}})}}function B(e){return{properties:e.getRoot().listMaterials().map(function(t){var r=t.listParents().filter(function(e){return"Root"!==e.propertyType}).length,n=new Set(t.listExtensions()),o=e.getGraph().getLinks().filter(function(e){var r=e.getChild(),o=e.getParent();return r instanceof i.Texture&&o===t||!!(r instanceof i.Texture&&o instanceof i.ExtensionProperty&&n.has(o))}).map(function(e){return e.getName()});return{name:t.getName(),instances:r,textures:o,alphaMode:t.getAlphaMode(),doubleSided:t.getDoubleSided()}})}}function _(e){return{properties:e.getRoot().listTextures().map(function(t){var r,n,o=t.listParents().filter(function(e){return"Root"!==e.propertyType}).length,a=e.getGraph().getLinks().filter(function(e){return e.getChild()===t}).map(function(e){return e.getName()}).filter(function(e){return"texture"!==e});return"image/png"===t.getMimeType()?(r=i.ImageUtils.getSizePNG(t.getImage()),n=4):"image/jpeg"===t.getMimeType()&&(r=i.ImageUtils.getSizeJPEG(t.getImage()),n=3),{name:t.getName(),uri:t.getURI(),slots:Array.from(new Set(a)),instances:o,mimeType:t.getMimeType(),resolution:r?r.join("x"):"",size:t.getImage().byteLength,memSize:r?r[0]*r[1]*n:null}})}}function F(e){return{properties:e.getRoot().listAnimations().map(function(e){var t=Infinity,r=-Infinity;e.listSamplers().forEach(function(e){t=Math.min(t,e.getInput().getMin([])[0]),r=Math.max(r,e.getInput().getMax([])[0])});var n=0,i=new Set;return e.listSamplers().forEach(function(e){i.add(e.getInput()),i.add(e.getOutput())}),Array.from(i).forEach(function(e){n+=e.getArray().byteLength}),{name:e.getName(),channels:e.listChannels().length,samplers:e.listSamplers().length,duration:Math.round(1e3*(r-t))/1e3,size:n}})}}var L=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"];function z(e){for(var t=0;t<e.length;t++)e[t].toFixed&&(e[t]=Number(e[t].toFixed(5)));return e}exports.ao=function(e){return void 0===e&&(e=m),e=u(u({},m),e),function(t){var r=t.getLogger(),n=e.resolution,i=e.samples;r.debug("ao: resolution = "+n+"; samples = "+i);var o=new Set;if(t.getRoot().listMeshes().forEach(function(e){e.listPrimitives().forEach(function(e){return o.add(e)})}),0===o.size)return r.warn("ao: No primitives found."),void r.debug("ao: Complete.");var a,s=t.createTexture("occlusion").setImage(p).setMimeType("image/png");if(e.gl){var u=e.gl(n,n);u.getExtension("OES_texture_float"),u.getExtension("OES_element_index_uint"),a=g({gl:u,extensions:["OES_texture_float","OES_element_index_uint"]})}Array.from(o).forEach(function(e,u){if(r.debug("ao: Baking primitive "+u+" / "+o.size+"."),e.getMaterial().getOcclusionTexture())r.warn("ao: Primitive already has AO. Is it sharing a material? Skipping.");else{for(var c=e.getAttribute("POSITION").getArray(),f=e.getIndices()?e.getIndices().getArray():void 0,g=l(c,{cells:f,resolution:n,regl:a}),m=0;m<i;m++)g.sample();var p=g.report();g.dispose();for(var d=p.length,h=new Float32Array(2*d),v=0;v<d;v++)h[2*v]=h[2*v+1]=1-p[v];var y=t.getRoot().listBuffers()[0]||t.createBuffer(""),b=t.createAccessor("uv2",y).setArray(h).setType("VEC2");e.setAttribute("TEXCOORD_1",b),e.getAttribute.TEXCOORD_0||e.setAttribute("TEXCOORD_0",b),e.getMaterial().setOcclusionTexture(s)}}),r.debug("ao: Complete.")}},exports.bounds=d,exports.center=function(e){return void 0===e&&(e=y),function(t){var r=t.getLogger(),n=t.getRoot(),i=n.listAnimations().length>0||n.listSkins().length>0;t.getRoot().listScenes().forEach(function(o,a){var s;if(r.debug("center: Scene "+(a+1)+" / "+n.listScenes().length+"."),"string"==typeof e.pivot){var u=d(o);s=[(u.max[0]-u.min[0])/2+u.min[0],(u.max[1]-u.min[1])/2+u.min[1],(u.max[2]-u.min[2])/2+u.min[2]],"above"===e.pivot&&(s[1]=u.max[1]),"below"===e.pivot&&(s[1]=u.min[1])}else s=e.pivot;r.debug('center: Pivot "'+s.join(", ")+'".');var c=[-1*s[0],-1*s[1],-1*s[2]];if(i){r.debug("center: Model contains animation or skin. Adding a wrapper node.");var f=t.createNode("Pivot").setTranslation(c);o.listChildren().forEach(function(e){return f.addChild(e)}),o.addChild(f)}else r.debug("center: Skipping wrapper, offsetting all root nodes."),o.listChildren().forEach(function(e){var t=e.getTranslation();e.setTranslation([t[0]+c[0],t[1]+c[1],t[2]+c[2]])})}),r.debug("center: Complete.")}},exports.colorspace=function(e){return function(t){var r=t.getLogger();if("linear"!==e.inputEncoding)if("sRGB"===e.inputEncoding){var n=new Set;t.getRoot().listMeshes().forEach(function(e){return e.listPrimitives().forEach(o)}),r.debug("colorspace: Complete.")}else r.error('colorspace: Unknown input encoding "'+e.inputEncoding+'" – should be "sRGB" or "linear". Skipping conversion.');else r.info("colorspace: Vertex colors already linear. Skipping conversion.");function i(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function o(e){for(var t,r=[],o=0;t=e.getAttribute("COLOR_"+o);o++)if(!n.has(t)){for(var a=0;a<t.getCount();a++)t.getElement(a,r),r[0]=i(r[0]),r[1]=i(r[1]),r[2]=i(r[2]),t.setElement(a,r);n.add(t)}}}},exports.dedup=function(e){return void 0===e&&(e=b),e=u(u({},b),e),function(t){var r=t.getLogger();!1!==e.accessors&&function(e,t){var r=new Set,n=new Set,o=t.getRoot().listMeshes();function a(e){for(var t=new Map,r=0;r<e.length;r++){var n=e[r],o=n.getArray().slice().buffer;if(!t.has(n))for(var a=0;a<e.length;a++){var s=e[a];n!==s&&(t.has(s)||n.getType()===s.getType()&&n.getComponentType()===s.getComponentType()&&n.getCount()===s.getCount()&&n.getNormalized()===s.getNormalized()&&i.BufferUtils.equals(o,s.getArray().slice().buffer)&&t.set(s,n))}}return t}o.forEach(function(e){e.listPrimitives().forEach(function(e){e.listAttributes().forEach(function(e){return n.add(e)}),e.getIndices()&&r.add(e.getIndices())})});var s=a(Array.from(r));e.debug("dedup: Found "+s.size+" duplicates among "+r.size+" indices.");var u=a(Array.from(n));e.debug("dedup: Found "+u.size+" duplicates among "+n.size+" attributes."),o.forEach(function(e){e.listPrimitives().forEach(function(e){e.listAttributes().forEach(function(t){u.has(t)&&e.swap(t,u.get(t))});var t=e.getIndices();t&&s.has(t)&&e.swap(t,s.get(t))})}),Array.from(s.keys()).forEach(function(e){return e.dispose()}),Array.from(u.keys()).forEach(function(e){return e.dispose()})}(r,t),!1!==e.textures&&function(e,t){for(var r=t.getRoot(),n=r.listTextures(),o=new Map,a=0;a<n.length;a++){var s=n[a],u=s.getImage();if(!o.has(s))for(var c=0;c<n.length;c++){var f=n[c],l=f.getImage();s!==f&&(o.has(f)||s.getMimeType()===f.getMimeType()&&s.getSize()[0]===f.getSize()[0]&&s.getSize()[1]===f.getSize()[1]&&i.BufferUtils.equals(u,l)&&o.set(f,s))}}e.debug("dedup: Found "+o.size+" duplicates among "+r.listTextures().length+" textures."),Array.from(o.entries()).forEach(function(e){var t=e[0],r=e[1];t.listParents().forEach(function(e){e instanceof i.Material&&e.swap(t,r)}),t.dispose()})}(r,t),r.debug("dedup: Complete.")}},exports.inspect=function(e){return{scenes:C(e),meshes:O(e),materials:B(e),textures:_(e),animations:F(e)}},exports.metalRough=function(e){return function(e){try{var t=function(){s.dispose();for(var e,t=f(u);!(e=t()).done;){var n=e.value;n&&1===n.listParents().length&&n.dispose()}r.debug("metalRough: Complete.")},r=e.getLogger(),n=o.MaterialsPBRSpecularGlossiness.EXTENSION_NAME;if(!e.getRoot().listExtensionsUsed().map(function(e){return e.extensionName}).includes(n))return r.warn("metalRough: Extension "+n+" not found on given document."),Promise.resolve();var i=e.createExtension(o.MaterialsIOR),a=e.createExtension(o.MaterialsSpecular),s=e.createExtension(o.MaterialsPBRSpecularGlossiness),u=new Set,c=function(e,t,r){if("function"==typeof e[A]){var n,i,o,a=e[A]();if(function e(r){try{for(;!(n=a.next()).done;)if((r=t(n.value))&&r.then){if(!R(r))return void r.then(e,o||(o=E.bind(null,i=new T,2)));r=r.v}i?E(i,1,r):i=r}catch(e){E(i||(i=new T),2,e)}}(),a.return){var s=function(e){try{n.done||a.return()}catch(e){}return e};if(i&&i.then)return i.then(s,function(e){throw s(e)});s()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var u=[],c=0;c<e.length;c++)u.push(e[c]);return function(e,t,r){var n,i,o=-1;return function a(s){try{for(;++o<e.length&&(!r||!r());)if((s=t(o))&&s.then){if(!R(s))return void s.then(a,i||(i=E.bind(null,n=new T,2)));s=s.v}n?E(n,1,s):n=s}catch(e){E(n||(n=new T),2,e)}}(),n}(u,function(e){return t(u[e])},void 0)}(e.getRoot().listMaterials(),function(t){function r(){t.setExtension("KHR_materials_pbrSpecularGlossiness",null)}var n=t.getExtension("KHR_materials_pbrSpecularGlossiness");if(n){var o=a.createSpecular().setSpecularFactor(1).setSpecularColorFactor(n.getSpecularFactor());u.add(n.getSpecularGlossinessTexture()),u.add(t.getBaseColorTexture()),u.add(t.getMetallicRoughnessTexture()),t.setBaseColorFactor(n.getDiffuseFactor()).setMetallicFactor(0).setRoughnessFactor(1).setExtension("KHR_materials_ior",i.createIOR().setIOR(1e3)).setExtension("KHR_materials_specular",o);var s=n.getDiffuseTexture();s&&(t.setBaseColorTexture(s),t.getBaseColorTextureInfo().copy(n.getDiffuseTextureInfo()));var c=n.getSpecularGlossinessTexture(),f=function(){if(c){var r=n.getSpecularGlossinessTextureInfo(),i=e.createTexture();return Promise.resolve(S(c,i,function(e,t,r){e.set(t,r,3,255)})).then(function(){o.setSpecularTexture(i),o.getSpecularTextureInfo().copy(r);var a=n.getGlossinessFactor(),s=e.createTexture();return Promise.resolve(S(c,s,function(e,t,r){var n=255-Math.round(e.get(t,r,3)*a);e.set(t,r,0,0),e.set(t,r,1,n),e.set(t,r,2,0),e.set(t,r,3,255)})).then(function(){t.setMetallicRoughnessTexture(s),t.getMetallicRoughnessTextureInfo().copy(r)})})}o.setSpecularColorFactor(n.getSpecularFactor()),t.setRoughnessFactor(1-n.getGlossinessFactor())}();return f&&f.then?f.then(r):r()}});return Promise.resolve(c&&c.then?c.then(t):t())}catch(e){return Promise.reject(e)}}},exports.partition=function(e){return e=u(u({},P),e),function(t){var r=t.getLogger();!1!==e.meshes&&function(e,t,r){var n=new Set(e.getRoot().listBuffers().map(function(e){return e.getURI()}));e.getRoot().listMeshes().forEach(function(i,o){if(!Array.isArray(r.meshes)||r.meshes.includes(i.getName())){t.debug(N+': Creating buffer for mesh "'+i.getName()+'".');var a=e.createBuffer(i.getName()).setURI(w(i.getName()||"mesh",n));i.listPrimitives().forEach(function(e){e.getIndices()&&e.getIndices().setBuffer(a),e.listAttributes().forEach(function(e){return e.setBuffer(a)}),e.listTargets().forEach(function(e){e.listAttributes().forEach(function(e){return e.setBuffer(a)})})})}else t.debug(N+": Skipping mesh at index "+o+' with name "'+i.getName()+'".')})}(t,r,e),!1!==e.animations&&function(e,t,r){var n=new Set(e.getRoot().listBuffers().map(function(e){return e.getURI()}));e.getRoot().listAnimations().forEach(function(i,o){if(!Array.isArray(r.animations)||r.animations.includes(i.getName())){t.debug(N+': Creating buffer for animation "'+i.getName()+'".');var a=e.createBuffer(i.getName()).setURI(w(i.getName()||"animation",n));i.listSamplers().forEach(function(e){e.getInput().setBuffer(a),e.getOutput().setBuffer(a)})}else t.debug(N+": Skipping animation at index "+o+' with name "'+i.getName()+'".')})}(t,r,e),e.meshes||e.animations||r.warn(N+": Select animations or meshes to create a partition."),r.debug(N+": Complete.")}},exports.sequence=function(e){return e=u(u({},M),e),function(t){var r=t.getLogger(),n=t.getRoot(),i=e.fps,o=n.listNodes().filter(function(t){return t.getName().match(e.pattern)});e.sort&&o.sort(function(e,t){return e.getName()>t.getName()?1:-1});var a=t.createAnimation(e.name),s=n.listBuffers()[0];o.forEach(function(e,r){var n,u;0===r?(n=[r/i,(r+1)/i],u=[1,1,1,0,0,0]):r===o.length-1?(n=[(r-1)/i,r/i],u=[0,0,0,1,1,1]):(n=[(r-1)/i,r/i,(r+1)/i],u=[0,0,0,1,1,1,0,0,0]);var c=t.createAccessor().setArray(new Float32Array(n)).setBuffer(s),f=t.createAccessor().setArray(new Float32Array(u)).setBuffer(s).setType("VEC3"),l=t.createAnimationSampler().setInterpolation("STEP").setInput(c).setOutput(f),g=t.createAnimationChannel().setTargetNode(e).setTargetPath("scale").setSampler(l);a.addSampler(l).addChannel(g)}),r.debug("sequence: Complete.")}};
//# sourceMappingURL=lib.js.map
